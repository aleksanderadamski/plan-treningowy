<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan Treningowy Pro</title>
    <!-- Biblioteki zewnƒôtrzne -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
          darkMode: 'class',
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
          --grad-color-1: #e0f2fe; --grad-color-2: #f0f9ff;
          --grad-color-3: #fefce8; --grad-color-4: #ecfdf5;
        }
        html.dark {
          --grad-color-1: #1e3a8a; --grad-color-2: #1e1b4b;
          --grad-color-3: #4a044e; --grad-color-4: #312e81;
        }
        body {
            font-family: 'Poppins', sans-serif;
            -webkit-tap-highlight-color: transparent;
            background: linear-gradient(-45deg, var(--grad-color-1), var(--grad-color-2), var(--grad-color-3), var(--grad-color-4));
            background-size: 400% 400%;
            animation: gradientFloat 25s ease infinite;
            background-position-y: calc(50% + var(--scroll-y, 0px));
            transition: background 0.5s ease;
            overflow-x: hidden;
            min-height: 100vh;
        }
        @keyframes gradientFloat {
            0% { background-position-x: 0%; }
            50% { background-position-x: 100%; }
            100% { background-position-x: 0%; }
        }
        .nav-btn.active { color: #2563eb; }
        html.dark .nav-btn.active { color: #60a5fa; }
        .page-pane { transition: transform 0.3s ease-out, opacity 0.3s ease-out; }
        
        @keyframes slide-in-from-right { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slide-out-to-left { from { transform: translateX(0); opacity: 1; } to { transform: translateX(-100%); opacity: 0; } }
        @keyframes slide-in-from-left { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slide-out-to-right { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
        .animate-slide-in-from-right { animation: slide-in-from-right 0.3s forwards; }
        .animate-slide-out-to-left { animation: slide-out-to-left 0.3s forwards; }
        .animate-slide-in-from-left { animation: slide-in-from-left 0.3s forwards; }
        .animate-slide-out-to-right { animation: slide-out-to-right 0.3s forwards; }

        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details summary:after { content: '+'; float: right; font-weight: bold; transition: transform 0.2s; }
        details[open] summary:after { transform: rotate(45deg); }
        
        #auth-overlay { backdrop-filter: blur(10px); }

        select option {
            background-color: #ffffff;
            color: #111827;
        }
        html.dark select option {
            background-color: #1f2937;
            color: #f9fafb;
        }

        .markdown-content p { margin-bottom: 0.5rem; }
        .markdown-content strong { color: #2563eb; font-weight: 700; }
        html.dark .markdown-content strong { color: #60a5fa; }
    </style>
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme');
            const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedTheme === 'dark' || (!savedTheme && systemDark)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        })();
    </script>
</head>
<body class="text-gray-800 dark:text-gray-300">

    <!-- Auth Overlay -->
    <div id="auth-overlay" class="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-white/70 dark:bg-gray-900/70 text-gray-900 dark:text-white text-center">
        <div class="w-full max-w-sm bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-2xl border border-gray-100 dark:border-gray-700 relative">
            <button id="auth-theme-toggle" class="absolute top-4 right-4 p-2 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition font-bold text-xs uppercase tracking-tighter">Tryb</button>
            <h2 class="text-2xl font-bold mb-6 tracking-tight uppercase">Witaj</h2>
            <div class="space-y-4">
                <button id="google-login" class="w-full flex items-center justify-center gap-3 p-3 border border-gray-200 dark:border-gray-600 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 transition font-bold text-gray-900 dark:text-white text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24s.92 7.54 2.55 10.78l7.98-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                    Google SSO
                </button>
                <div class="relative flex items-center py-2">
                    <div class="flex-grow border-t border-gray-200 dark:border-gray-600"></div><span class="px-3 text-[10px] text-gray-400 font-bold uppercase tracking-widest">lub email</span><div class="flex-grow border-t border-gray-200 dark:border-gray-600"></div>
                </div>
                <input type="email" id="auth-email" placeholder="EMAIL" class="w-full p-3 rounded-xl bg-gray-50 dark:bg-gray-900 border border-gray-100 dark:border-gray-700 outline-none focus:ring-2 focus:ring-blue-500 text-gray-900 dark:text-white font-bold text-xs">
                <input type="password" id="auth-password" placeholder="HAS≈ÅO" class="w-full p-3 rounded-xl bg-gray-50 dark:bg-gray-900 border border-gray-100 dark:border-gray-700 outline-none focus:ring-2 focus:ring-blue-500 text-gray-900 dark:text-white font-bold text-xs">
                <div class="flex gap-2">
                    <button id="email-login" class="flex-1 bg-blue-600 text-white p-3 rounded-xl font-bold hover:bg-blue-700 shadow-lg transition text-xs uppercase">Logowanie</button>
                    <button id="email-register" class="flex-1 border border-blue-600 text-blue-600 p-3 rounded-xl font-bold hover:bg-blue-50 dark:hover:bg-blue-900/10 transition text-xs uppercase">Rejestracja</button>
                </div>
            </div>
            <div id="auth-error-container" class="mt-4 p-3 bg-red-50 dark:bg-red-900/20 rounded-xl hidden text-left border border-red-200 dark:border-red-800">
                <p id="auth-error" class="text-[10px] text-red-600 dark:text-red-400 font-bold leading-tight whitespace-pre-wrap"></p>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="app-content" class="hidden pb-24">
        <header class="text-center p-6 bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm border-b border-gray-200/50 dark:border-gray-700/50 relative">
            <h1 class="text-xl font-bold text-gray-900 dark:text-gray-100 uppercase tracking-widest">Plan Treningowy</h1>
            <div class="flex flex-col items-center mt-2">
                <span id="user-id-display" class="text-[8px] opacity-50 font-mono text-gray-800 dark:text-gray-200 font-bold"></span>
                <button id="logout-btn" class="text-[10px] font-bold text-red-500 uppercase mt-1 hover:underline tracking-tighter">Wyloguj</button>
            </div>
            <button id="theme-toggle" class="p-2 absolute top-5 right-4 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition">
                <span id="theme-icon" class="font-bold">Motyw</span>
            </button>
        </header>

        <main class="p-4 max-w-lg mx-auto" id="main-content">
            <div id="tab-content">
                <div class="page-pane" id="harmonogram">
                    <div class="bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm p-4 rounded-xl shadow-sm mb-4 text-gray-900 dark:text-white">
                        <details>
                            <summary class="font-bold cursor-pointer uppercase text-sm tracking-tight">Zasady Progresji</summary>
                            <div class="mt-4 space-y-2 text-xs border-t pt-4 text-gray-600 dark:text-gray-300">
                                <p><strong class="text-blue-600 font-bold uppercase">Technika:</strong> Pe≈Çny zakres ruchu przed ciƒô≈ºarem.</p>
                                <p><strong class="text-blue-600 font-bold uppercase">Przerwy:</strong> 90-120s (G≈Ç√≥wne), 60s (Izolacje).</p>
                            </div>
                        </details>
                    </div>
                    <div class="bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm p-6 rounded-3xl shadow-sm text-center">
                        <h3 class="font-bold mb-4 text-gray-900 dark:text-white uppercase tracking-wider text-sm">Harmonogram</h3>
                        <div class="flex items-center justify-center space-x-4 mb-4">
                            <span class="text-xs font-bold">3 DNI</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="scheduleToggle" class="sr-only">
                                <div class="w-11 h-6 bg-gray-200 rounded-full dark:bg-gray-700"></div>
                                <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition shadow-sm"></div>
                            </label>
                            <span class="text-xs font-bold">4 DNI</span>
                        </div>
                        <div id="schedule-display" class="text-[10px] font-bold italic opacity-60 text-gray-900 dark:text-white uppercase tracking-tighter">Pon: PUSH | ≈ör: PULL | Pt: LEGS</div>
                    </div>
                </div>

                <!-- Workout Sections -->
                <div class="page-pane hidden" id="push">
                    <div class="flex justify-between items-center mb-4 text-gray-900 dark:text-white font-bold uppercase tracking-widest text-sm">Push <button data-workout="push" class="save-btn bg-blue-600 text-white px-4 py-1 rounded-lg text-xs font-bold uppercase shadow-sm">Zapisz</button></div>
                    <div id="push-cards" class="space-y-4 workout-cards-container"></div>
                </div>

                <div class="page-pane hidden" id="pull">
                    <div class="flex justify-between items-center mb-4 text-gray-900 dark:text-white font-bold uppercase tracking-widest text-sm">Pull <button data-workout="pull" class="save-btn bg-blue-600 text-white px-4 py-1 rounded-lg text-xs font-bold uppercase shadow-sm">Zapisz</button></div>
                    <div id="pull-cards" class="space-y-4 workout-cards-container"></div>
                </div>

                <div class="page-pane hidden" id="legs">
                    <div class="flex justify-between items-center mb-4 text-gray-900 dark:text-white font-bold uppercase tracking-widest text-sm">Legs <button data-workout="legs" class="save-btn bg-blue-600 text-white px-4 py-1 rounded-lg text-xs font-bold uppercase shadow-sm">Zapisz</button></div>
                    <div id="legs-cards" class="space-y-4 workout-cards-container"></div>
                </div>

                <div class="page-pane hidden" id="brzuch">
                    <div class="flex justify-between items-center mb-4 text-gray-900 dark:text-white font-bold uppercase tracking-widest text-sm">Core <button data-workout="brzuch" class="save-btn bg-blue-600 text-white px-4 py-1 rounded-lg text-xs font-bold uppercase shadow-sm">Zapisz</button></div>
                    <div id="brzuch-cards" class="space-y-4 workout-cards-container"></div>
                </div>
                
                <div class="page-pane hidden" id="postepy">
                    <h3 class="font-bold mb-4 uppercase text-center tracking-widest text-gray-900 dark:text-white text-sm">Postƒôpy Si≈Çowe</h3>
                    <div id="progress-accordion" class="space-y-3 mb-6"></div>
                    <div id="chart-container" class="hidden bg-white/60 dark:bg-gray-800/60 backdrop-blur-sm p-4 rounded-3xl shadow-sm border border-white/10 h-64">
                        <canvas id="progress-chart"></canvas>
                    </div>
                </div>

                <div class="page-pane hidden" id="ai-analiza">
                    <h3 class="font-bold mb-4 uppercase text-center tracking-widest text-gray-900 dark:text-white text-sm">Analiza Gemini 3</h3>
                    <div class="bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm p-6 rounded-3xl shadow-sm border border-blue-500/10 mb-4">
                        <p class="text-[10px] text-center opacity-70 mb-4 text-gray-700 dark:text-gray-300 uppercase font-bold tracking-tight text-balance">Model AI przeanalizuje logi treningowe, obliczy 1RM i wykryje stagnacjƒô</p>
                        <button id="generate-ai-insight" class="w-full bg-blue-600 text-white py-3 rounded-2xl font-bold uppercase text-xs shadow-md hover:bg-blue-700 transition-colors disabled:opacity-50">Generuj Raport</button>
                    </div>
                    <div id="ai-result-container" class="hidden bg-white/70 dark:bg-gray-900/70 backdrop-blur-xl p-6 rounded-3xl shadow-xl border border-blue-500/20">
                        <div id="ai-loading" class="flex flex-col items-center gap-3 py-8 hidden">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                            <span class="text-xs font-bold animate-pulse uppercase tracking-tighter">Analizowanie danych...</span>
                        </div>
                        <div id="ai-text" class="text-[11px] leading-relaxed markdown-content text-gray-800 dark:text-gray-200"></div>
                    </div>
                </div>

                <div class="page-pane hidden" id="dziennik">
                    <div class="flex justify-between items-center mb-4 text-gray-900 dark:text-white">
                        <h3 class="font-bold uppercase tracking-widest text-sm">Baza Log√≥w</h3>
                        <div class="flex gap-2">
                            <button id="import-pasted-csv" class="text-[10px] bg-blue-600 text-white px-3 py-1 rounded-lg font-bold uppercase">Sync</button>
                            <button id="copy-log" class="text-[10px] bg-gray-200 dark:bg-gray-700 px-3 py-1 rounded-lg font-bold uppercase">Kopiuj</button>
                        </div>
                    </div>
                    <textarea id="csv-output" placeholder="Data,Kategoria,Cwiczenie,Serie x Powt.,Ciezar" class="w-full h-80 p-4 text-[10px] font-mono rounded-3xl bg-gray-100/50 dark:bg-gray-900/50 outline-none resize-none border border-blue-500/20 text-gray-900 dark:text-blue-300"></textarea>
                    <button id="clear-log" class="w-full mt-4 bg-red-500/10 text-red-500 py-3 rounded-2xl text-xs font-bold uppercase tracking-wider">Wyczy≈õƒá historiƒô</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Navigation -->
    <nav id="app-nav" class="hidden fixed bottom-0 left-0 right-0 bg-white/80 dark:bg-gray-900/80 backdrop-blur-xl border-t border-gray-200 dark:border-gray-800 flex justify-around p-1 z-50 overflow-x-auto no-scrollbar">
        <button class="nav-btn px-2 py-2 flex flex-col items-center flex-shrink-0" data-tab="harmonogram">üè†<span class="text-[8px] font-bold">START</span></button>
        <button class="nav-btn px-2 py-2 flex flex-col items-center flex-shrink-0" data-tab="push">üí™<span class="text-[8px] font-bold">PUSH</span></button>
        <button class="nav-btn px-2 py-2 flex flex-col items-center flex-shrink-0" data-tab="pull">üèãÔ∏è<span class="text-[8px] font-bold">PULL</span></button>
        <button class="nav-btn px-2 py-2 flex flex-col items-center flex-shrink-0" data-tab="legs">ü¶µ<span class="text-[8px] font-bold">LEGS</span></button>
        <button class="nav-btn px-2 py-2 flex flex-col items-center flex-shrink-0" data-tab="brzuch">üî•<span class="text-[8px] font-bold">CORE</span></button>
        <button class="nav-btn px-2 py-2 flex flex-col items-center flex-shrink-0" data-tab="postepy">üìà<span class="text-[8px] font-bold">STATS</span></button>
        <button class="nav-btn px-2 py-2 flex flex-col items-center flex-shrink-0" data-tab="ai-analiza">ü§ñ<span class="text-[8px] font-bold">AI</span></button>
        <button class="nav-btn px-2 py-2 flex flex-col items-center flex-shrink-0" data-tab="dziennik">üìñ<span class="text-[8px] font-bold">LOGS</span></button>
    </nav>

    <div id="toast" class="fixed bottom-24 left-1/2 -translate-x-1/2 bg-gray-900 text-white text-[10px] px-6 py-2 rounded-full font-bold opacity-0 transition-opacity z-[200]"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, signInWithCustomToken, signInAnonymously } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, getDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
        import { getAnalytics } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js';

        // Klucz API dla Gemini - zapewniany przez ≈õrodowisko Google Cloud/Canvas.
        const apiKey = "AIzaSyAdWYZmp9zfQ7Rbvi91WBUSHPmgOWypAfM"; 

        const firebaseConfig = {
            apiKey: "AIzaSyAdWYZmp9zfQ7Rbvi91WBUSHPmgOWypAfM",
            authDomain: "training-assistant-44a28.firebaseapp.com",
            projectId: "training-assistant-44a28",
            storageBucket: "training-assistant-44a28.firebasestorage.app",
            messagingSenderId: "385371344810",
            appId: "1:385371344810:web:ee262a94683b54ad58e5d3",
            measurementId: "G-PBPMKQLKT8"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'training-assistant-44a28';
        
        try { getAnalytics(app); } catch (e) {}

        const workouts = {
            push: [
                { options: [{ name: "Wyciskanie sztangi na ≈Çawce p≈Çaskiej", sets: "4x6-8" }, { name: "Wyciskanie hantli (p≈Çasko)", sets: "4x6-8" }, { name: "Wyciskanie na maszynie siedzƒÖc (klatka)", sets: "4x8-10" }]},
                { options: [{ name: "Wyciskanie hantli (sko≈õna)", sets: "3x8-12" }, { name: "Wyciskanie sztangi na ≈Çawce sko≈õnej", sets: "3x8-12" }, { name: "Wyciskanie na maszynie Smitha (skos dodatni)", sets: "3x8-12" }]},
                { options: [{ name: "Pompki na porƒôczach (z obciƒÖ≈ºeniem)", sets: "3x8-12" }, { name: "Wyciskanie hantli nad g≈Çowƒô (siedzƒÖc)", sets: "3x8-12" }, { name: "Wyciskanie ≈ºo≈Çnierskie (sztanga stojƒÖc)", sets: "3x6-8" }]},
                { options: [{ name: "Wznosy hantli bokiem", sets: "4x10-15" }, { name: "Wznosy linek wyciƒÖgu w bok", sets: "4x10-15" }, { name: "Wznosy bokiem na maszynie", sets: "4x12-15" }]},
                { options: [{ name: "Rozpiƒôtki z hantlami", sets: "3x8-12"}, { name: "Rozpiƒôtki z linkami wyciƒÖgu (brama)", sets: "3x12-15" }, { name: "Rozpiƒôtki na maszynie 'Butterfly'", sets: "3x12-15" }]}, 
                { options: [{ name: "Prostowanie ramion (linka wyciƒÖgu) z dropsetem", sets: "3x10-15" }, { name: "Wyciskanie francuskie sztangƒÖ ≈ÇamanƒÖ", sets: "3x8-12" }, { name: "Wyciskanie francuskie hantlami (m≈Çotkowo)", sets: "3x10-12" }]}
            ],
            pull: [
                { options: [{ name: "PodciƒÖganie na drƒÖ≈ºku (nachwyt)", sets: "4xMAX" }, { name: "≈öciƒÖganie drƒÖ≈ºka wyciƒÖgu", sets: "4x8-12" }, { name: "≈öciƒÖganie na maszynie typu Hammer", sets: "4x8-12" }]},
                { options: [{ name: "Wios≈Çowanie sztangƒÖ (opad tu≈Çowia)", sets: "4x6-8" }, { name: "Wios≈Çowanie hantlem", sets: "4x8-10" }, { name: "Wios≈Çowanie p√≥≈ÇsztangƒÖ (T-Bar)", sets: "4x8-10" }]},
                { options: [{ name: "PrzyciƒÖganie uchwytu V (siedzƒÖc)", sets: "3x10-12" }, { name: "Wios≈Çowanie na maszynie siedzƒÖc", sets: "3x10-12" }, { name: "Wios≈Çowanie hantlami le≈ºƒÖc na ≈Çawce (chest supported)", sets: "3x10-12" }]},
                { options: [{ name: "≈öciƒÖganie drƒÖ≈ºka (proste ramiona)", sets: "3x12-15" }, { name: "Face pulls (linka)", sets: "3x15-20" }, { name: "Odwrotne rozpiƒôtki na maszynie (ty≈Ç barku)", sets: "3x12-15" }]},
                { options: [{ name: "Uginanie ramion ze sztangƒÖ", sets: "4x8-10" }, { name: "Uginanie z hantlami (supinacja)", sets: "4x8-10" }, { name: "Uginanie ramion z linkami wyciƒÖgu dolnego", sets: "4x10-12" }]},
                { options: [{ name: "Uginanie ramion z hantlami na ≈Çawce sko≈õnej", sets: "3x10-15" }, { name: "Uginanie ramion na modlitewniku", sets: "3x10-15" }, { name: "Uginanie m≈Çotkowe z hantlami", sets: "3x10-12" }]}
            ],
            legs: [
                { options: [{ name: "Przysiady ze sztangƒÖ na plecach", sets: "4x6-8" }, { name: "Wypychanie ciƒô≈ºaru na suwnicy", sets: "4x8-10" }, { name: "Przysiady na maszynie Hack", sets: "4x8-10" }]},
                { options: [{ name: "Martwy ciƒÖg na prostych nogach (RDL)", sets: "3x8-12" }, { name: "Uginanie n√≥g na maszynie le≈ºƒÖc", sets: "3x10-12" }, { name: "Uginanie n√≥g na maszynie siedzƒÖc", sets: "3x10-12" }]},
                { options: [{ name: "Przysiady bu≈Çgarskie", sets: "3x8-12 (na noga)" }, { name: "Wykroki z hantlami", sets: "3x10-12 (na noga)" }, { name: "Zakroki ze sztangƒÖ/hantlami", sets: "3x10-12 (na noga)" }]},
                { options: [{ name: "Prostowanie n√≥g na maszynie siedzƒÖc", sets: "3x12-15" }, { name: "Przysiad Goblet", sets: "3x12-15" }, { name: "Przysiad syzyfowy (Sissy Squat)", sets: "3xMAX" }]},
                { options: [{ name: "Hip Thrust ze sztangƒÖ", sets: "4x8-12" }, { name: "'≈ªuraw' (Glute Ham Raise)", sets: "3xMAX" }, { name: "Wyprosty tu≈Çowia na ≈Çawce rzymskiej (pod po≈õladki)", sets: "3x12-15" }]},
                { options: [{ name: "Wspiƒôcia na palce (stojƒÖc)", sets: "4x12-20" }, { name: "Wspiƒôcia na palce na suwnicy", sets: "4x15-25" }, { name: "Wspiƒôcia na palce siedzƒÖc", sets: "4x15-25" }]}
            ],
            brzuch: [
                { options: [{ name: "Allahy (linka wyciƒÖgu)", sets: "4x10-15" }, { name: "Spiƒôcia brzucha na maszynie", sets: "4x10-15" }, { name: "Spiƒôcia le≈ºƒÖc z talerzem na klatce", sets: "4x12-15" }]},
                { options: [{ name: "Unoszenie n√≥g w zwisie na drƒÖ≈ºku", sets: "4xMAX" }, { name: "Unoszenie kolan do klatki piersiowej w zwisie", sets: "4xMAX" }, { name: "Scyzoryki (V-ups)", sets: "4x15-20" }]},
                { options: [{ name: "Plank", sets: "4x60-90s" }, { name: "Plank boczny", sets: "3x45-60s (na str.)" }, { name: "Ab Wheel (k√≥≈Çko)", sets: "3x10-15" }]},
                { options: [{ name: "Wood choppers (rƒÖbanie drewna)", sets: "3x12-15 (na str.)" }, { name: "Russian Twist (skrƒôty tu≈Çowia)", sets: "3x15 (na stronƒô)" }, { name: "Pallof Press (antyrotacja z gumƒÖ/linkƒÖ)", sets: "3x12-15 (na str.)" }]}
            ]
        };

        const normalizeName = (name) => (name || "").replace(/['"]/g, "").trim();

        const exerciseMap = {};
        Object.keys(workouts).forEach(cat => {
            workouts[cat].forEach(slot => {
                slot.options.forEach(opt => {
                    exerciseMap[normalizeName(opt.name)] = cat.toUpperCase();
                });
            });
        });

        let trainingLogs = [];
        let chartInstance = null;
        let currentUser = null;

        const toggleTheme = () => {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        };

        document.getElementById('auth-theme-toggle').onclick = toggleTheme;
        document.getElementById('theme-toggle').onclick = toggleTheme;

        const showError = (msg) => {
            document.getElementById('auth-error-container').classList.remove('hidden');
            document.getElementById('auth-error').textContent = msg;
        };

        const loginWithGoogle = async () => {
            const provider = new GoogleAuthProvider();
            try { await signInWithPopup(auth, provider); } catch (e) { showError(`Auth Error: ${e.code}`); }
        };

        const loginWithEmail = async () => {
            const e = document.getElementById('auth-email').value;
            const p = document.getElementById('auth-password').value;
            if (!e || !p) return showError("Wprowad≈∫ dane.");
            try { await signInWithEmailAndPassword(auth, e, p); } catch (err) { showError(err.message); }
        };

        const registerWithEmail = async () => {
            const e = document.getElementById('auth-email').value;
            const p = document.getElementById('auth-password').value;
            if (!e || !p) return showError("Wprowad≈∫ dane.");
            try { await createUserWithEmailAndPassword(auth, e, p); } catch (err) { showError(err.message); }
        };

        document.getElementById('google-login').onclick = loginWithGoogle;
        document.getElementById('email-login').onclick = loginWithEmail;
        document.getElementById('email-register').onclick = registerWithEmail;
        document.getElementById('logout-btn').onclick = () => signOut(auth);

        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user && !user.isAnonymous) {
                document.getElementById('auth-overlay').classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');
                document.getElementById('app-nav').classList.remove('hidden');
                document.getElementById('user-id-display').textContent = user.email;
                syncLogs(user.uid);
            } else {
                document.getElementById('auth-overlay').classList.remove('hidden');
                document.getElementById('app-content').classList.add('hidden');
                document.getElementById('app-nav').classList.add('hidden');
            }
        });

        const syncLogs = (uid) => {
            onSnapshot(doc(db, 'artifacts', appId, 'users', uid, 'data', 'logs'), (snap) => {
                trainingLogs = snap.exists() ? (snap.data().entries || []) : [];
                renderAll();
            });
        };

        const saveToCloud = async (entries) => {
            if (!currentUser) return;
            await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'data', 'logs'), { entries: entries });
            showToast("Zsynchronizowano");
        };

        const getStats = (name) => {
            const filtered = trainingLogs.filter(l => normalizeName(l.exercise) === normalizeName(name));
            if (!filtered.length) return null;
            return { pb: Math.max(...filtered.map(l => l.weight)), last: filtered[filtered.length - 1].weight };
        };

        const renderAll = () => {
            Object.keys(workouts).forEach(type => {
                const container = document.getElementById(`${type}-cards`);
                if(!container) return;
                container.innerHTML = workouts[type].map((slot, i) => {
                    const stats = getStats(slot.options[0].name);
                    return `
                        <div class="card bg-white/60 dark:bg-gray-800/60 p-5 rounded-3xl border border-white/20 shadow-sm">
                            <select class="ex-select w-full bg-transparent font-bold text-xs outline-none mb-2 text-gray-900 dark:text-white" data-type="${type}" data-idx="${i}">
                                ${slot.options.map(o => `<option value="${o.name}">${o.name}</option>`).join('')}
                            </select>
                            <div class="stats-box text-[9px] font-bold text-blue-500 dark:text-blue-400 mb-4 px-1 flex gap-4">
                                ${stats ? `<span>üèÜ MAX: ${stats.pb}KG</span><span>‚èÆ OST: ${stats.last}KG</span>` : ''}
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="sets-display text-[9px] font-mono opacity-50 uppercase font-bold">${slot.options[0].sets}</span>
                                <div class="flex items-center gap-2">
                                    <input type="number" step="0.5" class="weight-input w-16 p-1 bg-slate-100 dark:bg-gray-700 rounded-lg text-center font-bold text-xs text-gray-900 dark:text-white" placeholder="0">
                                    <span class="text-[9px] font-bold uppercase opacity-50">kg</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            });
            updateHistoryUI();
        };

        document.body.addEventListener('change', (e) => {
            if(e.target.classList.contains('ex-select')) {
                const card = e.target.closest('.card');
                const selected = workouts[e.target.dataset.type][e.target.dataset.idx].options[e.target.selectedIndex];
                card.querySelector('.sets-display').textContent = selected.sets;
                const stats = getStats(selected.name);
                card.querySelector('.stats-box').innerHTML = stats ? `<span>üèÜ MAX: ${stats.pb}KG</span><span>‚èÆ OST: ${stats.last}KG</span>` : '';
            }
        });

        document.querySelectorAll('.save-btn').forEach(btn => {
            btn.onclick = () => {
                const category = btn.dataset.workout.toUpperCase();
                const container = document.getElementById(`${btn.dataset.workout}-cards`);
                const entries = [];
                const now = new Date().toISOString().split('T')[0];
                container.querySelectorAll('.card').forEach(card => {
                    const weight = parseFloat(card.querySelector('.weight-input').value);
                    if(!isNaN(weight) && weight > 0) {
                        entries.push({ 
                            date: now, 
                            category: category, 
                            exercise: card.querySelector('.ex-select').value, 
                            sets: card.querySelector('.sets-display').textContent,
                            weight 
                        });
                        card.querySelector('.weight-input').value = '';
                    }
                });
                if(entries.length) saveToCloud([...trainingLogs, ...entries]);
            };
        });

        const updateHistoryUI = () => {
            document.getElementById('csv-output').value = "Data,Kategoria,Cwiczenie,Serie x Powt.,Ciezar\n" + trainingLogs.map(l => {
                const cat = l.category || exerciseMap[normalizeName(l.exercise)] || 'INNE';
                return `${l.date},${cat},${l.exercise},${l.sets || ''},${l.weight}`;
            }).join('\n');
            
            const accordion = document.getElementById('progress-accordion');
            accordion.innerHTML = '';
            
            ['PUSH', 'PULL', 'LEGS', 'BRZUCH'].forEach(cat => {
                const exInCat = [...new Set(trainingLogs.filter(l => (l.category || exerciseMap[normalizeName(l.exercise)]) === cat).map(l => l.exercise))].sort();
                if(exInCat.length === 0) return;
                
                const details = document.createElement('details');
                details.className = 'bg-white/40 dark:bg-gray-800/40 rounded-2xl overflow-hidden';
                details.innerHTML = `
                    <summary class="p-4 font-bold text-[11px] uppercase tracking-widest cursor-pointer text-gray-800 dark:text-white">${cat}</summary>
                    <div class="p-2 space-y-1 bg-white/20 dark:bg-black/10">
                        ${exInCat.map(n => `<button class="w-full text-left p-3 rounded-xl text-[9px] font-bold uppercase text-gray-900 dark:text-white hover:bg-white/50 dark:hover:bg-gray-700/50" onclick="showChart('${n.replace(/'/g, "\\'")}')">${n}</button>`).join('')}
                    </div>
                `;
                accordion.appendChild(details);
            });
        };

        document.getElementById('import-pasted-csv').onclick = () => {
            const lines = document.getElementById('csv-output').value.split('\n');
            const newEntries = [];
            lines.forEach((line, i) => {
                if (i === 0 || !line.trim()) return;
                const parts = line.split(',');
                if (parts.length >= 3) {
                    const date = parts[0].trim();
                    let category, exercise, sets, weight;
                    if(parts.length === 5) {
                        category = parts[1].trim().toUpperCase();
                        exercise = parts[2].trim();
                        sets = parts[3].trim();
                        weight = parseFloat(parts[4]);
                    } else if(parts.length === 4) {
                        category = parts[1].trim().toUpperCase();
                        exercise = parts[2].trim();
                        weight = parseFloat(parts[3]);
                    } else {
                        exercise = parts[1].trim();
                        weight = parseFloat(parts[2]);
                        category = exerciseMap[normalizeName(exercise)] || 'INNE';
                    }
                    if(!isNaN(weight)) newEntries.push({ date, category, exercise, sets: sets || '', weight });
                }
            });
            if (newEntries.length) saveToCloud(newEntries);
        };

        window.showChart = (name) => {
            document.getElementById('chart-container').classList.remove('hidden');
            const ctx = document.getElementById('progress-chart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            const data = trainingLogs.filter(l => normalizeName(l.exercise) === normalizeName(name)).sort((a,b) => new Date(a.date) - new Date(b.date));
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: data.map(l => l.date), datasets: [{ data: data.map(l => l.weight), borderColor: '#2563eb', tension: 0.4, fill: false }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: false } } }
            });
            window.scrollTo({ top: document.getElementById('chart-container').offsetTop - 20, behavior: 'smooth' });
        };

        const callGemini = async (prompt, systemPrompt) => {
            const activeKey = apiKey || firebaseConfig.apiKey;
            // Aktualizacja modelu na Gemini 3 Flash zgodnie z TwojƒÖ informacjƒÖ
            const modelName = 'gemini-3-flash-preview';
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${activeKey}`;
            
            const payload = {
                contents: [{
                    parts: [
                        { text: systemPrompt },
                        { text: prompt }
                    ]
                }]
            };

            let delay = 1000;
            for (let i = 0; i < 5; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error(errData.error?.message || 'API Error');
                    }
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!text) throw new Error('Model zwr√≥ci≈Ç pustƒÖ odpowied≈∫');
                    return text;
                } catch (e) {
                    if (i === 4) throw e;
                    await new Promise(r => setTimeout(r, delay));
                    delay *= 2;
                }
            }
        };

        document.getElementById('generate-ai-insight').onclick = async () => {
            if (trainingLogs.length < 5) return showToast("Zbyt ma≈Ço danych (min. 5)");
            const btn = document.getElementById('generate-ai-insight');
            const resultBox = document.getElementById('ai-result-container');
            const loading = document.getElementById('ai-loading');
            const textEl = document.getElementById('ai-text');
            btn.disabled = true;
            resultBox.classList.remove('hidden');
            loading.classList.remove('hidden');
            textEl.innerHTML = '';
            const dataSummary = trainingLogs.slice(-30).map(l => `${l.date}, ${l.exercise}, ${l.weight}kg`).join('\n');
            const systemPrompt = "Jeste≈õ trenerem personalnym. Analizujesz historiƒô treningowƒÖ. Cel: 1. Szacuj 1RM g≈Ç√≥wnych boj√≥w. 2. Wykryj stagnacjƒô. 3. Zasugeruj obciƒÖ≈ºenia na kolejny trening (+2.5kg lub +5%). Formatuj w punktach, u≈ºywaj **pogrubie≈Ñ**. Pisz kr√≥tko i konkretnie po polsku.";
            const prompt = `Analizuj ostatnie wpisy:\n${dataSummary}`;
            try {
                const response = await callGemini(prompt, systemPrompt);
                loading.classList.add('hidden');
                textEl.innerHTML = response.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
            } catch (e) {
                loading.classList.add('hidden');
                textEl.innerHTML = `<span class="text-red-500 font-bold uppercase text-[10px]">B≈ÇƒÖd: ${e.message}</span>`;
            } finally { btn.disabled = false; }
        };

        const tabOrder = ['harmonogram', 'push', 'pull', 'legs', 'brzuch', 'postepy', 'ai-analiza', 'dziennik'];
        const navigate = (id, dir = null) => {
            const curr = document.querySelector('.page-pane:not(.hidden)');
            const dest = document.getElementById(id);
            if(curr === dest) return;
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === id));
            if(dir) {
                curr.classList.add(dir === 'L' ? 'animate-slide-out-to-left' : 'animate-slide-out-to-right');
                dest.classList.add(dir === 'L' ? 'animate-slide-in-from-right' : 'animate-slide-in-from-left');
            }
            dest.classList.remove('hidden');
            setTimeout(() => { 
                curr.className = 'page-pane hidden'; 
                dest.className = 'page-pane'; 
                if(id === 'postepy') updateHistoryUI(); 
            }, 300);
        };
        document.querySelectorAll('.nav-btn').forEach(b => b.onclick = () => navigate(b.dataset.tab));
        const showToast = (m) => { const t = document.getElementById('toast'); t.textContent = m; t.style.opacity = '1'; setTimeout(() => t.style.opacity = '0', 2000); };
        window.onscroll = () => document.body.style.setProperty('--scroll-y', `${window.scrollY / -15}px`);
        document.getElementById('clear-log').onclick = async () => { if(confirm('Wyczy≈õciƒá chmurƒô?') && currentUser) await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'data', 'logs'), { entries: [] }); };
        document.getElementById('copy-log').onclick = () => { document.getElementById('csv-output').select(); document.execCommand('copy'); showToast('Kopia OK'); };
        const scheduleToggle = document.getElementById('scheduleToggle');
        scheduleToggle.onchange = () => {
            document.getElementById('schedule-display').textContent = scheduleToggle.checked ? "PUSH, PULL, LEGS..." : "Pon: PUSH | ≈ör: PULL | Pt: LEGS";
            document.querySelector('.dot').style.transform = scheduleToggle.checked ? 'translateX(1.25rem)' : 'translateX(0)';
        };
        renderAll();
    </script>
</body>
</html>