<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan Treningowy Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
          darkMode: 'class',
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
          --grad-color-1: #e0f2fe; --grad-color-2: #f0f9ff;
          --grad-color-3: #fefce8; --grad-color-4: #ecfdf5;
        }
        html.dark {
          --grad-color-1: #1e3a8a; --grad-color-2: #1e1b4b;
          --grad-color-3: #4a044e; --grad-color-4: #312e81;
        }
        body {
            font-family: 'Poppins', sans-serif;
            -webkit-tap-highlight-color: transparent;
            background: linear-gradient(-45deg, var(--grad-color-1), var(--grad-color-2), var(--grad-color-3), var(--grad-color-4));
            background-size: 400% 400%;
            animation: gradientFloat 25s ease infinite;
            transition: background 0.5s ease;
            overflow-x: hidden;
            min-height: 100vh;
        }
        @keyframes gradientFloat {
            0% { background-position-x: 0%; }
            50% { background-position-x: 100%; }
            100% { background-position-x: 0%; }
        }
        .nav-btn.active { color: #2563eb; }
        html.dark .nav-btn.active { color: #60a5fa; }
        .page-pane { transition: transform 0.3s ease-out, opacity 0.3s ease-out; }
        
        #auth-overlay { backdrop-filter: blur(10px); }

        .markdown-content p { margin-bottom: 0.5rem; }
        .markdown-content strong { color: #2563eb; font-weight: 700; }
        html.dark .markdown-content strong { color: #60a5fa; }

        .system-select-btn.active {
            background-color: #2563eb;
            color: white;
            border-color: #2563eb;
        }
        html.dark .system-select-btn.active {
            background-color: #3b82f6;
        }
    </style>
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme');
            const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedTheme === 'dark' || (!savedTheme && systemDark)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        })();
    </script>
</head>
<body class="text-gray-800 dark:text-gray-300">

    <div id="auth-overlay" class="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-white/70 dark:bg-gray-900/70 text-gray-900 dark:text-white text-center">
        <div class="w-full max-w-sm bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-2xl border border-gray-100 dark:border-gray-700 relative">
            <button id="auth-theme-toggle" class="absolute top-4 right-4 p-2 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition font-bold text-xs uppercase tracking-tighter">Tryb</button>
            <h2 class="text-2xl font-bold mb-6 tracking-tight uppercase">Witaj</h2>
            <div class="space-y-4">
                <button id="google-login" class="w-full flex items-center justify-center gap-3 p-3 border border-gray-200 dark:border-gray-600 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 transition font-bold text-gray-900 dark:text-white text-sm">
                    Google SSO
                </button>
                <div class="relative flex items-center py-2">
                    <div class="flex-grow border-t border-gray-200 dark:border-gray-600"></div><span class="px-3 text-[10px] text-gray-400 font-bold uppercase tracking-widest">lub email</span><div class="flex-grow border-t border-gray-200 dark:border-gray-600"></div>
                </div>
                <input type="email" id="auth-email" placeholder="EMAIL" class="w-full p-3 rounded-xl bg-gray-50 dark:bg-gray-900 border border-gray-100 dark:border-gray-700 outline-none focus:ring-2 focus:ring-blue-500 text-gray-900 dark:text-white font-bold text-xs">
                <input type="password" id="auth-password" placeholder="HAS≈ÅO" class="w-full p-3 rounded-xl bg-gray-50 dark:bg-gray-900 border border-gray-100 dark:border-gray-700 outline-none focus:ring-2 focus:ring-blue-500 text-gray-900 dark:text-white font-bold text-xs">
                <div class="flex gap-2">
                    <button id="email-login" class="flex-1 bg-blue-600 text-white p-3 rounded-xl font-bold hover:bg-blue-700 shadow-lg transition text-xs uppercase">Logowanie</button>
                    <button id="email-register" class="flex-1 border border-blue-600 text-blue-600 p-3 rounded-xl font-bold hover:bg-blue-900/10 transition text-xs uppercase">Rejestracja</button>
                </div>
            </div>
            <div id="auth-error-container" class="mt-4 p-3 bg-red-50 dark:bg-red-900/20 rounded-xl hidden text-left border border-red-200 dark:border-red-800">
                <p id="auth-error" class="text-[10px] text-red-600 dark:text-red-400 font-bold leading-tight whitespace-pre-wrap"></p>
            </div>
        </div>
    </div>

    <div id="app-content" class="hidden pb-24">
        <header class="text-center p-6 bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm border-b border-gray-200/50 dark:border-gray-700/50 relative">
            <h1 class="text-xl font-bold text-gray-900 dark:text-gray-100 uppercase tracking-widest">Plan Treningowy</h1>
            <div class="flex flex-col items-center mt-2">
                <span id="user-id-display" class="text-[8px] opacity-50 font-mono text-gray-800 dark:text-gray-200 font-bold"></span>
                <button id="logout-btn" class="text-[10px] font-bold text-red-500 uppercase mt-1 hover:underline tracking-tighter">Wyloguj</button>
            </div>
            <button id="theme-toggle" class="p-2 absolute top-5 right-4 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition">
                <span id="theme-icon" class="font-bold text-xs uppercase">Tryb</span>
            </button>
        </header>

        <main class="p-4 max-w-lg mx-auto" id="main-content">
            <div id="tab-content">
                <div class="page-pane" id="harmonogram">
                    <div class="bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm p-6 rounded-3xl shadow-sm text-center mb-4">
                        <h3 class="font-bold mb-4 text-gray-900 dark:text-white uppercase tracking-wider text-sm">System Treningowy</h3>
                        <div class="flex gap-2 justify-center mb-6">
                            <button class="system-select-btn flex-1 py-3 border border-gray-200 dark:border-gray-600 rounded-xl font-bold text-xs uppercase transition-all" data-system="PPL">Push/Pull/Legs</button>
                            <button class="system-select-btn flex-1 py-3 border border-gray-200 dark:border-gray-600 rounded-xl font-bold text-xs uppercase transition-all" data-system="FBW">Full Body Workout</button>
                        </div>
                        <div id="schedule-display" class="text-[10px] font-bold italic opacity-60 text-gray-900 dark:text-white uppercase tracking-tighter">Wybierz system powy≈ºej</div>
                    </div>
                </div>

                <!-- PPL Sections -->
                <div class="page-pane hidden ppl-only" id="push">
                    <div class="flex justify-between items-center mb-4 text-gray-900 dark:text-white font-bold uppercase tracking-widest text-sm">Push <button data-workout="push" class="save-btn bg-blue-600 text-white px-4 py-1 rounded-lg text-xs font-bold uppercase shadow-sm">Zapisz</button></div>
                    <div id="push-cards" class="space-y-4 workout-cards-container"></div>
                </div>
                <div class="page-pane hidden ppl-only" id="pull">
                    <div class="flex justify-between items-center mb-4 text-gray-900 dark:text-white font-bold uppercase tracking-widest text-sm">Pull <button data-workout="pull" class="save-btn bg-blue-600 text-white px-4 py-1 rounded-lg text-xs font-bold uppercase shadow-sm">Zapisz</button></div>
                    <div id="pull-cards" class="space-y-4 workout-cards-container"></div>
                </div>
                <div class="page-pane hidden ppl-only" id="legs">
                    <div class="flex justify-between items-center mb-4 text-gray-900 dark:text-white font-bold uppercase tracking-widest text-sm">Legs <button data-workout="legs" class="save-btn bg-blue-600 text-white px-4 py-1 rounded-lg text-xs font-bold uppercase shadow-sm">Zapisz</button></div>
                    <div id="legs-cards" class="space-y-4 workout-cards-container"></div>
                </div>
                <div class="page-pane hidden ppl-only" id="brzuch">
                    <div class="flex justify-between items-center mb-4 text-gray-900 dark:text-white font-bold uppercase tracking-widest text-sm">Core <button data-workout="brzuch" class="save-btn bg-blue-600 text-white px-4 py-1 rounded-lg text-xs font-bold uppercase shadow-sm">Zapisz</button></div>
                    <div id="brzuch-cards" class="space-y-4 workout-cards-container"></div>
                </div>

                <!-- FBW Sections -->
                <div class="page-pane hidden fbw-only" id="trening-a">
                    <div class="flex justify-between items-center mb-4 text-gray-900 dark:text-white font-bold uppercase tracking-widest text-sm">Trening A <button data-workout="trening-a" class="save-btn bg-blue-600 text-white px-4 py-1 rounded-lg text-xs font-bold uppercase shadow-sm">Zapisz</button></div>
                    <div id="trening-a-cards" class="space-y-4 workout-cards-container"></div>
                </div>
                <div class="page-pane hidden fbw-only" id="trening-b">
                    <div class="flex justify-between items-center mb-4 text-gray-900 dark:text-white font-bold uppercase tracking-widest text-sm">Trening B <button data-workout="trening-b" class="save-btn bg-blue-600 text-white px-4 py-1 rounded-lg text-xs font-bold uppercase shadow-sm">Zapisz</button></div>
                    <div id="trening-b-cards" class="space-y-4 workout-cards-container"></div>
                </div>
                
                <div class="page-pane hidden" id="postepy">
                    <h3 class="font-bold mb-4 uppercase text-center tracking-widest text-gray-900 dark:text-white text-sm">Postƒôpy Si≈Çowe</h3>
                    <div id="progress-accordion" class="space-y-3 mb-6"></div>
                    <div id="chart-container" class="hidden bg-white/60 dark:bg-gray-800/60 backdrop-blur-sm p-4 rounded-3xl shadow-sm border border-white/10 h-64">
                        <canvas id="progress-chart"></canvas>
                    </div>
                </div>

                <div class="page-pane hidden" id="dziennik">
                    <div class="flex justify-between items-center mb-4 text-gray-900 dark:text-white">
                        <h3 class="font-bold uppercase tracking-widest text-sm text-bold">Logi CSV</h3>
                        <div class="flex gap-2">
                            <button id="import-pasted-csv" class="text-[10px] bg-blue-600 text-white px-3 py-1 rounded-lg font-bold uppercase">Sync</button>
                            <button id="copy-log" class="text-[10px] bg-gray-200 dark:bg-gray-700 px-3 py-1 rounded-lg font-bold uppercase">Kopiuj</button>
                        </div>
                    </div>
                    <textarea id="csv-output" placeholder="Data,System,Kategoria,ƒÜwiczenie,Ciƒô≈ºar" class="w-full h-80 p-4 text-[10px] font-mono rounded-3xl bg-gray-100/50 dark:bg-gray-900/50 outline-none resize-none border border-blue-500/20 text-gray-900 dark:text-blue-300"></textarea>
                    <button id="clear-log" class="w-full mt-4 bg-red-500/10 text-red-500 py-3 rounded-2xl text-xs font-bold uppercase tracking-wider">Wyczy≈õƒá historiƒô</button>
                </div>
            </div>
        </main>
    </div>

    <nav id="app-nav" class="hidden fixed bottom-0 left-0 right-0 bg-white/80 dark:bg-gray-900/80 backdrop-blur-xl border-t border-gray-200 dark:border-gray-800 flex justify-around p-1 z-50 overflow-x-auto no-scrollbar">
        <button class="nav-btn px-2 py-2 flex flex-col items-center flex-shrink-0" data-tab="harmonogram">üè†<span class="text-[8px] font-bold">START</span></button>
        
        <!-- PPL Nav -->
        <button class="nav-btn ppl-nav px-2 py-2 flex flex-col items-center flex-shrink-0" data-tab="push">üí™<span class="text-[8px] font-bold">PUSH</span></button>
        <button class="nav-btn ppl-nav px-2 py-2 flex flex-col items-center flex-shrink-0" data-tab="pull">üèãÔ∏è<span class="text-[8px] font-bold">PULL</span></button>
        <button class="nav-btn ppl-nav px-2 py-2 flex flex-col items-center flex-shrink-0" data-tab="legs">ü¶µ<span class="text-[8px] font-bold">LEGS</span></button>
        <button class="nav-btn ppl-nav px-2 py-2 flex flex-col items-center flex-shrink-0" data-tab="brzuch">üî•<span class="text-[8px] font-bold">CORE</span></button>

        <!-- FBW Nav -->
        <button class="nav-btn fbw-nav px-2 py-2 flex flex-col items-center flex-shrink-0 hidden" data-tab="trening-a">üÖ∞Ô∏è<span class="text-[8px] font-bold">TRENING A</span></button>
        <button class="nav-btn fbw-nav px-2 py-2 flex flex-col items-center flex-shrink-0 hidden" data-tab="trening-b">üÖ±Ô∏è<span class="text-[8px] font-bold">TRENING B</span></button>

        <button class="nav-btn px-2 py-2 flex flex-col items-center flex-shrink-0" data-tab="postepy">üìà<span class="text-[8px] font-bold">STATS</span></button>
        <button class="nav-btn px-2 py-2 flex flex-col items-center flex-shrink-0" data-tab="dziennik">üìñ<span class="text-[8px] font-bold">LOG</span></button>
    </nav>

    <div id="toast" class="fixed bottom-24 left-1/2 -translate-x-1/2 bg-gray-900 text-white text-[10px] px-6 py-2 rounded-full font-bold opacity-0 transition-opacity z-[200]"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, signInWithCustomToken, signInAnonymously } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, getDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
        import { getAnalytics } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js';

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'training-pro-v3';
        
        try { getAnalytics(app); } catch (e) {}

        const workouts = {
            push: [
                { options: [{ name: "Wyciskanie sztangi p≈Çasko", sets: "4x6-8" }, { name: "Wyciskanie hantli p≈Çasko", sets: "4x8-10" }]},
                { options: [{ name: "Wyciskanie hantli skos", sets: "3x10-12" }]},
                { options: [{ name: "OHP sztanga", sets: "3x8-10" }]},
                { options: [{ name: "Wznosy bokiem", sets: "4x15-20" }]},
                { options: [{ name: "Pompki na porƒôczach", sets: "3x10-12" }]},
                { options: [{ name: "Prostowanie linek", sets: "3x12-15" }]}
            ],
            pull: [
                { options: [{ name: "PodciƒÖganie", sets: "4xMAX" }]},
                { options: [{ name: "Wios≈Çowanie sztangƒÖ", sets: "4x8-10" }]},
                { options: [{ name: "PrzyciƒÖganie wyciƒÖg dolny", sets: "3x10-12" }]},
                { options: [{ name: "Facepulls", sets: "3x15-20" }]},
                { options: [{ name: "Uginanie ramion sztanga", sets: "4x10-12" }]},
                { options: [{ name: "M≈Çotki", sets: "3x12-15" }]}
            ],
            legs: [
                { options: [{ name: "Przysiady", sets: "4x6-8" }]},
                { options: [{ name: "RDL", sets: "4x10-12" }]},
                { options: [{ name: "Suwnica", sets: "3x12-15" }]},
                { options: [{ name: "Uginanie n√≥g", sets: "3x12-15" }]},
                { options: [{ name: "Wspiƒôcia stojƒÖc", sets: "4x15-20" }]}
            ],
            brzuch: [
                { options: [{ name: "Allahy", sets: "4x15" }]},
                { options: [{ name: "Unoszenie n√≥g", sets: "4xMAX" }]}
            ],
            "trening-a": [
                { options: [{ name: "FBW A: Przyk≈Çadowe 1", sets: "3x8" }]},
                { options: [{ name: "FBW A: Przyk≈Çadowe 2", sets: "3x10" }]}
            ],
            "trening-b": [
                { options: [{ name: "FBW B: Przyk≈Çadowe 1", sets: "3x8" }]},
                { options: [{ name: "FBW B: Przyk≈Çadowe 2", sets: "3x10" }]}
            ]
        };

        const normalizeName = (name) => (name || "").replace(/['"]/g, "").trim();

        let trainingLogs = [];
        let currentUser = null;
        let chartInstance = null;
        let currentSystem = localStorage.getItem('trainingSystem') || 'PPL';

        const showError = (msg) => {
            const container = document.getElementById('auth-error-container');
            const text = document.getElementById('auth-error');
            if (container && text) {
                container.classList.remove('hidden');
                text.textContent = msg;
            }
        };

        const hideError = () => {
            const container = document.getElementById('auth-error-container');
            if (container) container.classList.add('hidden');
        };

        const switchSystem = (system) => {
            currentSystem = system;
            localStorage.setItem('trainingSystem', system);
            
            document.querySelectorAll('.system-select-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.system === system);
            });

            const isPPL = system === 'PPL';
            document.querySelectorAll('.ppl-nav').forEach(el => el.classList.toggle('hidden', !isPPL));
            document.querySelectorAll('.fbw-nav').forEach(el => el.classList.toggle('hidden', isPPL));
            
            const scheduleDisplay = document.getElementById('schedule-display');
            if (scheduleDisplay) {
                scheduleDisplay.textContent = isPPL 
                    ? "Pon: PUSH | ≈ör: PULL | Pt: LEGS" 
                    : "Tydzie≈Ñ: Trening A / Trening B / Trening A";
            }

            navigate('harmonogram');
            updateHistoryUI();
        };

        document.querySelectorAll('.system-select-btn').forEach(btn => {
            btn.onclick = () => switchSystem(btn.dataset.system);
        });

        const toggleTheme = () => {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeUI(isDark);
        };

        const updateThemeUI = (isDark) => {
            const icon = document.getElementById('theme-icon');
            if (icon) icon.textContent = isDark ? 'Jasny' : 'Ciemny';
            const authIcon = document.getElementById('auth-theme-toggle');
            if (authIcon) authIcon.textContent = isDark ? 'Jasny' : 'Ciemny';
        };

        document.getElementById('auth-theme-toggle').onclick = toggleTheme;
        document.getElementById('theme-toggle').onclick = toggleTheme;

        const loginWithGoogle = async () => {
            hideError();
            const provider = new GoogleAuthProvider();
            provider.setCustomParameters({ prompt: 'select_account' });
            try { 
                await signInWithPopup(auth, provider); 
            } catch (e) { 
                showError(`B≈ÇƒÖd Google SSO: ${e.message}`); 
            }
        };

        const loginWithEmail = async () => {
            hideError();
            const e = document.getElementById('auth-email').value;
            const p = document.getElementById('auth-password').value;
            if (!e || !p) return showError("Wprowad≈∫ dane.");
            try { await signInWithEmailAndPassword(auth, e, p); } catch (err) { showError(err.message); }
        };

        const registerWithEmail = async () => {
            hideError();
            const e = document.getElementById('auth-email').value;
            const p = document.getElementById('auth-password').value;
            if (!e || !p) return showError("Wprowad≈∫ dane.");
            try { await createUserWithEmailAndPassword(auth, e, p); } catch (err) { showError(err.message); }
        };

        document.getElementById('google-login').onclick = loginWithGoogle;
        document.getElementById('email-login').onclick = loginWithEmail;
        document.getElementById('email-register').onclick = registerWithEmail;
        document.getElementById('logout-btn').onclick = () => signOut(auth);

        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                document.getElementById('auth-overlay').classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');
                document.getElementById('app-nav').classList.remove('hidden');
                document.getElementById('user-id-display').textContent = user.email;
                syncLogs(user.uid);
                switchSystem(currentSystem);
            } else {
                document.getElementById('auth-overlay').classList.remove('hidden');
                document.getElementById('app-content').classList.add('hidden');
                document.getElementById('app-nav').classList.add('hidden');
            }
        });

        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                try { await signInWithCustomToken(auth, __initial_auth_token); } catch(e) {}
            }
        };
        initAuth();

        const syncLogs = (uid) => {
            onSnapshot(doc(db, 'artifacts', appId, 'users', uid, 'data', 'logs'), (snap) => {
                trainingLogs = snap.exists() ? (snap.data().entries || []) : [];
                renderAll();
            }, (err) => {
                console.error("Firestore sync error:", err);
            });
        };

        const renderAll = () => {
            Object.keys(workouts).forEach(type => {
                const container = document.getElementById(`${type}-cards`);
                if(!container) return;
                container.innerHTML = workouts[type].map((slot, i) => `
                    <div class="card bg-white/60 dark:bg-gray-800/60 p-5 rounded-3xl border border-white/20 shadow-sm">
                        <select class="ex-select w-full bg-transparent font-bold text-xs outline-none mb-2 text-gray-900 dark:text-white" data-type="${type}" data-idx="${i}">
                            ${slot.options.map(o => `<option value="${o.name}">${o.name}</option>`).join('')}
                        </select>
                        <div class="flex items-center justify-between">
                            <span class="sets-display text-[9px] font-mono opacity-50 uppercase font-bold">${slot.options[0].sets}</span>
                            <div class="flex items-center gap-2">
                                <input type="number" step="0.5" class="weight-input w-16 p-1 bg-slate-100 dark:bg-gray-700 rounded-lg text-center font-bold text-xs text-gray-900 dark:text-white" placeholder="0">
                                <span class="text-[9px] font-bold uppercase opacity-50">kg</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            });
            updateHistoryUI();
        };

        document.querySelectorAll('.save-btn').forEach(btn => {
            btn.onclick = async () => {
                const type = btn.dataset.workout;
                const container = document.getElementById(`${type}-cards`);
                const entries = [];
                const now = new Date().toISOString().split('T')[0];
                container.querySelectorAll('.card').forEach(card => {
                    const weight = parseFloat(card.querySelector('.weight-input').value);
                    if(!isNaN(weight) && weight > 0) {
                        entries.push({ 
                            date: now, 
                            system: currentSystem,
                            category: type.toUpperCase(), 
                            exercise: card.querySelector('.ex-select').value, 
                            weight 
                        });
                        card.querySelector('.weight-input').value = '';
                    }
                });
                if(entries.length) {
                    await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'data', 'logs'), { entries: [...trainingLogs, ...entries] });
                    showToast("Zsynchronizowano");
                }
            };
        });

        const updateHistoryUI = () => {
            const filtered = trainingLogs.filter(l => l.system === currentSystem);
            
            document.getElementById('csv-output').value = "Data,System,Kategoria,Cwiczenie,Ciezar\n" + filtered.map(l => {
                return `${l.date},${l.system || 'PPL'},${l.category},${l.exercise},${l.weight}`;
            }).join('\n');
            
            const accordion = document.getElementById('progress-accordion');
            accordion.innerHTML = '';
            
            const exercises = [...new Set(filtered.map(l => l.exercise))].sort();
            exercises.forEach(ex => {
                const btn = document.createElement('button');
                btn.className = 'w-full text-left p-4 bg-white/40 dark:bg-gray-800/40 rounded-2xl font-bold text-xs uppercase tracking-widest mb-2';
                btn.textContent = ex;
                btn.onclick = () => showChart(ex);
                accordion.appendChild(btn);
            });
        };

        const showChart = (name) => {
            document.getElementById('chart-container').classList.remove('hidden');
            const ctx = document.getElementById('progress-chart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            const data = trainingLogs.filter(l => normalizeName(l.exercise) === normalizeName(name)).sort((a,b) => new Date(a.date) - new Date(b.date));
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: data.map(l => l.date), datasets: [{ data: data.map(l => l.weight), borderColor: '#2563eb', tension: 0.4, fill: false }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
            window.scrollTo({ top: document.getElementById('chart-container').offsetTop - 20, behavior: 'smooth' });
        };

        const navigate = (id) => {
            document.querySelectorAll('.page-pane').forEach(p => p.classList.add('hidden'));
            const dest = document.getElementById(id);
            if (dest) dest.classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === id));
            if (id === 'postepy') updateHistoryUI();
        };

        document.querySelectorAll('.nav-btn').forEach(b => b.onclick = () => navigate(b.dataset.tab));
        
        const showToast = (m) => { 
            const t = document.getElementById('toast'); 
            if (t) {
                t.textContent = m; t.style.opacity = '1'; 
                setTimeout(() => t.style.opacity = '0', 2000); 
            }
        };

        document.getElementById('clear-log').onclick = async () => { 
            if(confirm('Wyczy≈õciƒá chmurƒô?') && currentUser) {
                await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'data', 'logs'), { entries: [] }); 
            }
        };

        document.getElementById('copy-log').onclick = () => { 
            document.getElementById('csv-output').select(); 
            document.execCommand('copy'); 
            showToast('Skopiowano!'); 
        };

        renderAll();
    </script>
</body>
</html>